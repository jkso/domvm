// https://github.com/leeoniya/domvm (3.x-dev, pico build)
!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.domvm=e()}(this,function(){"use strict";var n=1,e=2,t=3,l=4,r=5,o="undefined"!=typeof window,u=o?window:{},i=o?document:{},a=u.requestAnimationFrame,f={};function d(){}var s=Array.isArray;function c(n){return null!=n&&n.constructor===Object}function v(n){return"function"==typeof n}function y(n,e){for(var t in n)if(n[t]!==e[t])return!1;return!0}function p(n,e){var t=n.length;if(e.length!==t)return!1;for(var l=0;l<t;l++)if(n[l]!==e[l])return!1;return!0}function h(n){if(!a)return n;var e,t,l;function r(){e=0,n.apply(t,l)}return function(){t=this,l=arguments,e||(e=a(r))}}function g(n){return"o"===n[0]&&"n"===n[1]}function b(n){return"_"===n[0]}function k(n){n&&n.el&&n.el.offsetHeight}function m(n){return null!=n.node&&null!=n.node.el}function _(n,e){switch(e){case"value":case"checked":case"selected":return!0}return!1}function w(n){for(n=n||f;null==n.vm&&n.parent;)n=n.parent;return n.vm}function x(){}x.prototype={constructor:x,type:null,vm:null,key:null,ref:null,data:null,hooks:null,ns:null,el:null,tag:null,attrs:null,body:null,flags:0,_class:null,_diff:null,_dead:!1,_lis:!1,idx:null,parent:null};function N(n){var t=new x;return t.type=e,t.body=n,t}var A={};var R=1,E=2,S=4,C=8;function V(e,t,l,r){var o=new x;o.type=n,o.flags=r||0,o.attrs=t||null;var u,i=(u=e,A.tag=u,A);o.tag=i.tag;var a=null!=i.id,f=null!=i.class,d=null!=i.attrs;if(a||f||d){var s=o.attrs||{};if(a&&null==s.id&&(s.id=i.id),f&&(o._class=i.class,s.class=i.class+(null!=s.class?" "+s.class:"")),d)for(var c in i.attrs)null==s[c]&&(s[c]=i.attrs[c]);o.attrs=s}var v=o.attrs;return null!=v&&(null!=v._key&&(o.key=v._key),null!=v._ref&&(o.ref=v._ref),null!=v._hooks&&(o.hooks=v._hooks),null!=v._data&&(o.data=v._data),null!=v._flags&&(o.flags=v._flags),null==o.key&&(null!=o.ref?o.key=o.ref:null!=v.id?o.key=v.id:null!=v.name&&(o.key=v.name+("radio"===v.type||"checkbox"===v.type?v.value:"")))),null!=l&&(o.body=l),o}function T(n,t,o,u){if(n.type!==r&&n.type!==l){var i,a,f;n.parent=t,n.idx=o,n.vm=u,null!=n.ref&&(i=w(n),a=n.ref,f=n,function(n,e,t){for(var l;l=e.shift();)0===e.length?n[l]=t:n[l]=n=n[l]||{}}(i,["refs"].concat(a.split(".")),f));var d=n.hooks,c=u&&u.hooks;(d&&(d.willRemove||d.didRemove)||c&&(c.willUnmount||c.didUnmount))&&function(n){for(;n=n.parent;)n.flags|=R}(n),s(n.body)?function(n){for(var t=n.body,l=0;l<t.length;l++){var r=t[l];!1===r||null==r?t.splice(l--,1):s(r)?(u=r,i=l--,a=1,(o=t).splice.apply(o,[i,a].concat(u))):(null==r.type&&(t[l]=r=N(""+r)),r.type===e?null==r.body||""===r.body?t.splice(l--,1):l>0&&t[l-1].type===e?(t[l-1].body+=r.body,t.splice(l--,1)):T(r,n,l,null):T(r,n,l,null))}var o,u,i,a}(n):""===n.body&&(n.body=null)}}function j(n,e){var t,l=(n.attrs||f).style,r=e?(e.attrs||f).style:null;if(null==l||("string"===(t=typeof l)||"number"===t))n.el.style.cssText=l;else{for(var o in l){var u=l[o];(null==r||null!=u&&u!==r[o])&&(n.el.style[o]=u)}if(r)for(var i in r)null==l[i]&&(n.el.style[i]="")}}var D=[];function I(n,e,t,l,r){if(null!=n){var o=t.hooks[e];if(o){if("d"!==e[0]||"i"!==e[1]||"d"!==e[2])return o(t,l);r?k(t.parent)&&o(t,l):D.push([o,t,l])}}}function L(n){var e;if(D.length)for(k(n.node);e=D.shift();)e[0](e[1],e[2])}function M(n){return n.nextSibling}function U(n,e,t){var l=e._node,r=l.vm;if(s(l.body))if((l.flags&R)===R)for(var o=0;o<l.body.length;o++)U(e,l.body[o].el);else Y(l);delete e._node,n.removeChild(e),I(l.hooks,"didRemove",l,null,t),null!=r&&(I(r.hooks,"didUnmount",r,r.data,t),r.node=null)}function O(n,e){var t=e._node;if(!t._dead){var l,r,o,u,i=function n(e){var t=e.vm,l=null!=t&&I(t.hooks,"willUnmount",t,t.data),r=I(e.hooks,"willRemove",e);if((e.flags&R)===R&&s(e.body))for(var o=0;o<e.body.length;o++)n(e.body[o]);return l||r}(t);null!=i&&("object"==typeof(u=i)&&v(u.then))?(t._dead=!0,i.then((l=U,r=[n,e,!0],function(){return l.apply(o,r)}))):U(n,e)}}function Y(n){for(var e=n.body,t=0;t<e.length;t++){var l=e[t];delete l.el._node,null!=l.vm&&(l.vm.node=null),s(l.body)&&Y(l)}}function B(n){var e=n.el;if(0==(n.flags&R))s(n.body)&&Y(n),e.textContent=null;else{var t=e.firstChild;do{var l=M(t);O(e,t)}while(t=l)}}function F(n,e,t){var l=e._node,r=null!=e.parentNode,o=e!==t&&r?null:l.vm;null!=o&&I(o.hooks,"willMount",o,o.data),I(l.hooks,r?"willReinsert":"willInsert",l),n.insertBefore(e,t),I(l.hooks,r?"didReinsert":"didInsert",l),null!=o&&I(o.hooks,"didMount",o,o.data)}function P(n,e,t){F(n,e,t?M(t):null)}var q=d,z=!1;function H(n,e,t){n[e]=t}function K(n,e,t,l,r){var o=n.apply(r,e.concat([t,l,r,r.data]));r.onevent(t,l,r,r.data,e),q.call(null,t,l,r,r.data,e),!1===o&&(t.preventDefault(),t.stopPropagation())}function X(n){var e,t,l=function(n){for(;null==n._node;)n=n.parentNode;return n._node}(n.target),r=w(l),o=n.currentTarget._node.attrs["on"+n.type];if(s(o))K(e=o[0],t=o.slice(1),n,l,r);else for(var u in o)if(n.target.matches(u)){var i=o[u];s(i)?(e=i[0],t=i.slice(1)):(e=i,t=[]),K(e,t,n,l,r)}}function Z(n,e,t,l){if(t!==l){var r=n.el;null==t||v(t)?H(r,e,t):null==l&&H(r,e,X)}}function G(n,e,t){var l,r,o,u,i,a,d,s,c=n.attrs||f,v=e.attrs||f;if(c===v);else{for(var y in c){var p=c[y];if(null!=p){var h=_(n.tag,y),k=h?n.el[y]:v[y];p===k||("style"===y?j(n,e):b(y)||(g(y)?Z(n,y,p,k):(i=y,a=p,d=h,s=void 0,s=(u=n).el,null!=u.ns?s.setAttribute(i,a):"class"===i?s.className=a:"id"===i||"boolean"==typeof a||d?s[i]=a:"."===i[0]?s[i.substr(1)]=a:s.setAttribute(i,a))))}}for(var y in v)null==c[y]&&!b(y)&&(l=n,r=y,o=_(n.tag,y)||g(y),"."===r[0]&&(r=r.substr(1),o=!0),o?l.el[r]="":l.el.removeAttribute(r))}}function J(n,e,t,r){return n.type===l&&(e=n.data,t=n.key,r=n.opts,n=n.view),new sn(n,e,t,r)}function Q(n){for(var e=0;e<n.body.length;e++){var o=n.body[e],u=o.type;if(u<=t)F(n.el,W(o));else if(u===l){u=(i=J(o.view,o.data,o.key,o.opts)._redraw(n,e,!1)).node.type,F(n.el,W(i.node))}else if(u===r){var i;(i=o.vm)._redraw(n,e),u=i.node.type,F(n.el,i.node.el)}}}function W(l,r){var o,u,a,d;return null==l.el&&(l.type===n?(l.el=r||(a=l.tag,null!=(d=l.ns)?i.createElementNS(d,a):i.createElement(a)),null!=l.attrs&&G(l,f),(l.flags&C)===C&&l.body.body(l),s(l.body)?Q(l):null!=l.body&&(l.el.textContent=l.body)):l.type===e?l.el=r||(u=l.body,i.createTextNode(u)):l.type===t&&(l.el=r||(o=l.body,i.createComment(o)))),l.el._node=l,l.el}var $=1,nn=2;function en(n,e,t,l,r,o,u,i){return function(a,f,d,s,c,v){var y,p;if(null!=s[l]){if(null==(y=s[l]._node))return void(s[l]=n(s[l]));if(y.parent!==a)return p=n(s[l]),null!=y.vm?y.vm.unmount(!0):O(f,s[l]),void(s[l]=p)}if(s[r]==c)return nn;if(null==s[r].el)t(f,W(s[r]),s[l]),s[r]=e(s[r],d);else if(s[r].el===s[l])s[r]=e(s[r],d),s[l]=n(s[l]);else{if(v||y!==s[u])return v&&null!=s[l]?function(n,e,t,l,r,o,u,i,a){if(i._lis)t(o,a[r].el,a[l]),a[r]=e(a[r],u);else{var f=function(n,e){var t,l=0,r=e.length-1;if(r<=2147483647)for(;l<=r;){if(e[t=l+r>>1]===n)return t;e[t]<n?l=t+1:r=t-1}else for(;l<=r;){if(e[t=Math.floor((l+r)/2)]===n)return t;e[t]<n?l=t+1:r=t-1}return l==e.length?null:l}(i.idx,a.tombs);i._lis=!0;var d=n(a[l]);t(o,a[l],null!=f?u[a.tombs[f]].el:f),null==f?a.tombs.push(i.idx):a.tombs.splice(f,0,i.idx),a[l]=d}}(n,e,t,l,r,f,d,y,s):$;p=s[l],s[l]=n(p),i(f,p,s[o]),s[o]=p}}}var tn=en(M,function(n,e){return e[n.idx+1]},F,"lftSib","lftNode","rgtSib","rgtNode",P),ln=en(function(n){return n.previousSibling},function(n,e){return e[n.idx-1]},P,"rgtSib","rgtNode","lftSib","lftNode",F);function rn(n,e,t,l){for(var r=[],o=r.slice.call(e.childNodes),u=0;u<o.length;u++){var i=o[u]._node;i.parent===n&&r.push(i.idx)}for(var a=function(n){var e,t,l=n.slice(),r=[];r.push(0);for(var o=0,u=n.length;o<u;++o){var i=r[r.length-1];if(n[i]<n[o])l[o]=i,r.push(o);else{for(e=0,t=r.length-1;e<t;){var a=(e+t)/2|0;n[r[a]]<n[o]?e=a+1:t=a}n[o]<n[r[e]]&&(e>0&&(l[o]=r[e-1]),r[e]=o)}}for(t=r[(e=r.length)-1];e-- >0;)r[e]=t,t=l[t];return r}(r).map(function(n){return r[n]}),f=0;f<a.length;f++)t[a[f]]._lis=!0;for(l.tombs=a;;){if(tn(n,e,t,l,null,!0)===nn)break}}function on(n){return n.el._node.parent!==n.parent}function un(n,e,t){return e[t]}function an(n,e,t){for(;t<e.length;t++){var o=e[t];if(null!=o.vm){if(n.type===l&&o.vm.view===n.view&&o.vm.key===n.key||n.type===r&&o.vm===n.vm)return o}else if(!on(o)&&n.tag===o.tag&&n.type===o.type&&n.key===o.key&&(n.flags&~R)==(o.flags&~R))return o}return null}function fn(n,e,t){if(null==e._keys){if(e[t].key===n.key)return e[t];for(var l={},r=0;r<e.length;r++)l[e[r].key]=r;e._keys=l}return e[e._keys[n.key]]}function dn(o,u){I(u.hooks,"willRecycle",u,o);var i=o.el=u.el,a=u.body,c=o.body;if(i._node=o,o.type!==e||c===a){null==o.attrs&&null==u.attrs||G(o,u);var v=s(a),y=s(c),p=(o.flags&C)===C;v?y||p?function(e,o){var u=e.body,i=u.length,a=o.body,s=a.length,c=(e.flags&C)===C,v=(e.flags&E)===E,y=(e.flags&S)===S,p=!v&&e.type===n,h=!0,g=0===s?d:y?fn:v||c?un:an;if(p&&0===i)return B(o),void(c&&(e.body=[]));var b,k,_=0,w=!1,x=0;if(c)var N={key:null},A=Array(i);for(var R=0;R<i;R++){if(c){var V=!1,j=null;h&&(y&&(N.key=u.key(R)),b=g(N,a,x)),null!=b?(k=b.idx,!0===(j=u.diff(R,b))?((D=b).parent=e,D.idx=R,D._lis=!1):V=!0):V=!0,V&&(T(D=u.tpl(R),e,R),D._diff=null!=j?j:u.diff(R),null!=b&&dn(D,b)),A[R]=D}else{var D=u[R],I=D.type;if(I<=t)(b=h&&g(D,a,x))&&(dn(D,b),k=b.idx);else if(I===l){if(b=h&&g(D,a,x)){k=b.idx;var L=b.vm._update(D.data,e,R)}else var L=J(D.view,D.data,D.key,D.opts)._redraw(e,R,!1);I=L.node.type}else if(I===r){var M=m(D.vm),L=D.vm._update(D.data,e,R,M);I=L.node.type}}if(null!=b&&(k===x?++x===s&&i>s&&(b=null,h=!1):w=!0,!y&&s>100&&w&&++_%10==0))for(;x<s&&on(a[x]);)x++}c&&(e.body=A);p&&function(n,e){var t=e.body,l=n.el,r=n.body,o={lftNode:r[0],rgtNode:r[r.length-1],lftSib:(t[0]||f).el,rgtSib:(t[t.length-1]||f).el};n:for(;;){for(;;){var u=tn(n,l,r,o,null,!1);if(u===$)break;if(u===nn)break n}for(;;){var i=ln(n,l,r,o,o.lftNode,!1);if(i===$)break;if(i===nn)break n}rn(n,l,r,o);break}}(e,o)}(o,u):c!==a&&(null!=c?i.textContent=c:B(u)):y?(B(u),Q(o)):c!==a&&(null!=c&&null!=a?i.firstChild.nodeValue=c:i.textContent=c),I(u.hooks,"didRecycle",u,o)}else i.nodeValue=c}function sn(n,e,t,l){var r=this;r.view=n,r.data=e,r.key=t,l&&(r.opts=l,r.config(l));var o=c(n)?n:n.call(r,r,e,t,l);v(o)?r.render=o:(r.render=o.render,r.config(o)),r.init&&r.init.call(r,r,r.data,r.key,l)}sn.prototype={constructor:sn,_diff:null,init:null,view:null,key:null,data:null,state:null,api:null,opts:null,node:null,hooks:null,onevent:d,refs:null,render:null,mount:function(n,e){var t=this;e?(B({el:n,flags:0}),t._redraw(null,null,!1),n.nodeName.toLowerCase()!==t.node.tag?(W(t.node),F(n.parentNode,t.node.el,n),n.parentNode.removeChild(n)):F(n.parentNode,W(t.node,n),n)):(t._redraw(null,null),n&&F(n,t.node.el));n&&L(t);return t},unmount:function(n){var e=this.node;O(e.el.parentNode,e.el),n||L(this)},config:function(n){var e=this;n.init&&(e.init=n.init),n.diff&&(e.diff=n.diff),n.onevent&&(e.onevent=n.onevent),n.hooks&&(e.hooks=function(n){for(var e=arguments,t=1;t<e.length;t++)for(var l in e[t])n[l]=e[t][l];return n}(e.hooks||{},n.hooks))},parent:function(){return w(this.node.parent)},root:function(){for(var n=this.node;n.parent;)n=n.parent;return n.vm},redraw:function(n){null==n&&(n=z);var e=this;return n?e._redraw(null,null,m(e)):(e._redrawAsync=e._redrawAsync||h(function(n){return e.redraw(!0)}))(),e},update:function(n,e){null==e&&(e=z);var t=this;return e?t._update(n,null,null,m(t)):(t._updateAsync=t._updateAsync||h(function(n){return t.update(n,!0)}))(n),t},_update:function(n,e,t,l){var r=this;null!=n&&r.data!==n&&(I(r.hooks,"willUpdate",r,n),r.data=n);return r._redraw(e,t,l)},_redraw:function(n,e,t){var l,r,o=null==n,u=this,i=u.node&&u.node.el&&u.node.el.parentNode,a=u.node;if(null!=u.diff&&(l=u._diff,u._diff=r=u.diff(u,u.data),null!=a)){var f=s(l)?p:y,d=l===r||f(l,r);if(d)return cn(u,a,n,e)}i&&I(u.hooks,"willRedraw",u,u.data);var c=u.render.call(u,u,u.data,l,r);if(c===a)return cn(u,a,n,e);u.refs=null,null!=u.key&&c.key!==u.key&&(c.key=u.key);u.node=c,n?(T(c,n,e,u),n.body[e]=c):a&&a.parent?(T(c,a.parent,a.idx,u),a.parent.body[a.idx]=c):T(c,null,null,u);if(!1!==t)if(a)if(a.tag!==c.tag||a.key!==c.key){a.vm=c.vm=null;var v=a.el.parentNode,h=M(a.el);O(v,a.el),F(v,W(c),h),a.el=c.el,c.vm=u}else dn(c,a);else W(c);i&&I(u.hooks,"didRedraw",u,u.data),o&&i&&L(u);return u},_redrawAsync:null,_updateAsync:null};function cn(n,e,t,l){return null!=t&&(t.body[l]=e,e.idx=l,e.parent=t,e._lis=!1),n}function vn(n,e,t,l){var r,o;return null==t?c(e)?r=e:o=e:(r=e,o=t),V(n,r,o,l)}var yn="http://www.w3.org/2000/svg";function pn(n,e,t,l){this.view=n,this.data=e,this.key=t,this.opts=l}function hn(n){this.vm=n}return pn.prototype={constructor:pn,type:l,view:null,data:null,key:null,opts:null},hn.prototype={constructor:hn,type:r,vm:null},{config:function(n){q=n.onevent||q,null!=n.syncRedraw&&(z=n.syncRedraw)},ViewModel:sn,VNode:x,createView:J,defineElement:vn,defineSvgElement:function(n,e,t,l){var r=vn(n,e,t,l);return r.ns=yn,r},defineText:N,defineComment:function(n){var e=new x;return e.type=t,e.body=n,e},defineView:function(n,e,t,l){return new pn(n,e,t,l)},injectView:function(n){return new hn(n)},injectElement:function(e){var t=new x;return t.type=n,t.el=t.key=e,t},lazyList:function(n,e){var t=n.length,l={items:n,length:t,key:function(t){return e.key(n[t],t)},diff:function(t,l){var r=e.diff(n[t],t);if(null==l)return r;var o=l._diff;return(r===o||s(o)?p(r,o):y(r,o))||r},tpl:function(t){return e.tpl(n[t],t)},map:function(n){return e.tpl=n,l},body:function(n){for(var e=Array(t),r=0;r<t;r++){var o=l.tpl(r);o._diff=l.diff(r),e[r]=o,T(o,n,r)}n.body=e}};return l},FIXED_BODY:E,DEEP_REMOVE:R,KEYED_LIST:S,LAZY_LIST:C}});