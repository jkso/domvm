// https://github.com/leeoniya/domvm (3.x-dev, pico build)

!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.domvm=e()}(this,function(){"use strict";function n(){}function e(n){return null!=n&&n.constructor===Object}function t(n,e,t,l){n.splice.apply(n,[t,l].concat(e))}function l(n){return"function"==typeof n}function r(n,e){for(var t in n)if(n[t]!==e[t])return!1;return!0}function i(n,e){var t=n.length;if(e.length!==t)return!1;for(var l=0;l<t;l++)if(n[l]!==e[l])return!1;return!0}function o(n){function e(){t=0,n.apply(l,r)}if(!un)return n;var t,l,r;return function(){l=this,r=arguments,t||(t=un(e))}}function u(n){return"o"===n[0]&&"n"===n[1]}function a(n){return"_"===n[0]}function f(n){return"style"===n}function s(n){n&&n.el&&n.el.offsetHeight}function d(n){return null!=n.node&&null!=n.node.el}function c(n,e){switch(e){case"value":case"checked":case"selected":return!0}return!1}function v(n){for(n=n||an;null==n.vm&&n.parent;)n=n.parent;return n.vm}function y(){}function h(n){var e=new y;return e.type=$,e.body=n,e}function p(n,e,t,l){var r=new y;r.type=W,r.flags=l||0,r.attrs=e||null;var i=function(n){return sn.tag=n,sn}(n);r.tag=i.tag;var o=null!=i.id,u=null!=i.class,a=null!=i.attrs;if(o||u||a){var f=r.attrs||{};if(o&&null==f.id&&(f.id=i.id),u&&(r._class=i.class,f.class=i.class+(null!=f.class?" "+f.class:"")),a)for(var s in i.attrs)null==f[s]&&(f[s]=i.attrs[s]);r.attrs=f}var d=r.attrs;return null!=d&&(null!=d._key&&(r.key=d._key),null!=d._ref&&(r.ref=d._ref),null!=d._hooks&&(r.hooks=d._hooks),null!=d._data&&(r.data=d._data),null!=d._flags&&(r.flags=d._flags),null==r.key&&(null!=r.ref?r.key=r.ref:null!=d.id?r.key=d.id:null!=d.name&&(r.key=d.name+("radio"===d.type||"checkbox"===d.type?d.value:"")))),null!=t&&(r.body=t),r}function g(n,e,l,r){if(n.type!==tn&&n.type!==en){n.parent=e,n.idx=l,n.vm=r,null!=n.ref&&function(n,e,t){!function(n,e,t){for(var l;l=e.shift();)0===e.length?n[l]=t:n[l]=n=n[l]||{}}(n,["refs"].concat(e.split(".")),t)}(v(n),n.ref,n);var i=n.hooks,o=r&&r.hooks;(i&&(i.willRemove||i.didRemove)||o&&(o.willUnmount||o.didUnmount))&&function(n){for(;n=n.parent;)n.flags|=dn}(n),fn(n.body)?function(n){for(var e=n.body,l=0;l<e.length;l++){var r=e[l];!1===r||null==r?e.splice(l--,1):fn(r)?t(e,r,l--,1):(null==r.type&&(e[l]=r=h(""+r)),r.type===$?null==r.body||""===r.body?e.splice(l--,1):l>0&&e[l-1].type===$?(e[l-1].body+=r.body,e.splice(l--,1)):g(r,n,l,null):g(r,n,l,null))}}(n):""===n.body&&(n.body=null)}}function b(n,e){return e}function k(n,e){var t=(n.attrs||an).style,l=e?(e.attrs||an).style:null;if(null==t||function(n){var e=typeof n;return"string"===e||"number"===e}(t))n.el.style.cssText=t;else{for(var r in t){var i=t[r];(null==l||null!=i&&i!==l[r])&&(n.el.style[r]=b(0,i))}if(l)for(var o in l)null==t[o]&&(n.el.style[o]="")}}function m(n,e,t,l,r){if(null!=n){var i=t.hooks[e];if(i){if("d"!==e[0]||"i"!==e[1]||"d"!==e[2])return i(t,l);r?s(t.parent)&&i(t,l):hn.push([i,t,l])}}}function _(n){if(hn.length){s(n.node);for(var e;e=hn.shift();)e[0](e[1],e[2])}}function w(n){return n.nextSibling}function x(n){var e=n.vm,t=null!=e&&m(e.hooks,"willUnmount",e,e.data),l=m(n.hooks,"willRemove",n);if((n.flags&dn)===dn&&fn(n.body))for(var r=0;r<n.body.length;r++)x(n.body[r]);return t||l}function N(n,e,t){var l=e._node,r=l.vm;if(fn(l.body))if((l.flags&dn)===dn)for(var i=0;i<l.body.length;i++)N(e,l.body[i].el);else R(l);delete e._node,n.removeChild(e),m(l.hooks,"didRemove",l,null,t),null!=r&&(m(r.hooks,"didUnmount",r,r.data,t),r.node=null)}function A(n,e){var t=e._node;if(!t._dead){var r=x(t);null!=r&&function(n){return"object"==typeof n&&l(n.then)}(r)?(t._dead=!0,r.then(function(n,e,t){return function(){return n.apply(t,e)}}(N,[n,e,!0]))):N(n,e)}}function R(n){for(var e=n.body,t=0;t<e.length;t++){var l=e[t];delete l.el._node,null!=l.vm&&(l.vm.node=null),fn(l.body)&&R(l)}}function E(n){var e=n.el;if(0==(n.flags&dn))fn(n.body)&&R(n),e.textContent=null;else{var t=e.firstChild;do{var l=w(t);A(e,t)}while(t=l)}}function S(n,e,t){var l=e._node,r=null!=e.parentNode,i=e!==t&&r?null:l.vm;null!=i&&m(i.hooks,"willMount",i,i.data),m(l.hooks,r?"willReinsert":"willInsert",l),n.insertBefore(e,t),m(l.hooks,r?"didReinsert":"didInsert",l),null!=i&&m(i.hooks,"didMount",i,i.data)}function C(n,e,t){S(n,e,t?w(t):null)}function V(n,e,t){n[e]=t}function T(n,e,t,l,r){var i=n.apply(r,e.concat([t,l,r,r.data]));r.onevent(t,l,r,r.data,e),pn.call(null,t,l,r,r.data,e),!1===i&&(t.preventDefault(),t.stopPropagation())}function j(n){var e,t,l=function(n){for(;null==n._node;)n=n.parentNode;return n._node}(n.target),r=v(l),i=n.currentTarget._node.attrs["on"+n.type];if(fn(i))T(e=i[0],t=i.slice(1),n,l,r);else for(var o in i)if(n.target.matches(o)){var u=i[o];fn(u)?(e=u[0],t=u.slice(1)):(e=u,t=[]),T(e,t,n,l,r)}}function D(n,e,t,r){if(t!==r){var i=n.el;null==t||l(t)?V(i,e,t):null==r&&V(i,e,j)}}function I(n,e,t){"."===e[0]&&(e=e.substr(1),t=!0),t?n.el[e]="":n.el.removeAttribute(e)}function L(n,e,t,l,r){var i=n.el;null!=n.ns?i.setAttribute(e,t):"class"===e?i.className=t:"id"===e||"boolean"==typeof t||l?i[e]=t:"."===e[0]?i[e.substr(1)]=t:i.setAttribute(e,t)}function M(n,e,t){var l=n.attrs||an,r=e.attrs||an;if(l===r);else{for(var i in l){var o=l[i];if(null!=o){var s=c(n.tag,i),d=s?n.el[i]:r[i];o===d||(f(i)?k(n,e):a(i)||(u(i)?D(n,i,o,d):L(n,i,o,s)))}}for(var i in r)null==l[i]&&!a(i)&&I(n,i,c(n.tag,i)||u(i))}}function U(n,e,t,l){return n.type===en&&(e=n.data,t=n.key,l=n.opts,n=n.view),new X(n,e,t,l)}function O(n){for(var e=0;e<n.body.length;e++){var t=n.body[e],l=t.type;if(l<=nn)S(n.el,Y(t));else if(l===en){l=(r=U(t.view,t.data,t.key,t.opts)._redraw(n,e,!1)).node.type,S(n.el,Y(r.node))}else if(l===tn){var r;(r=t.vm)._redraw(n,e),l=r.node.type,S(n.el,r.node.el)}}}function Y(n,e){return null==n.el&&(n.type===W?(n.el=e||function(n,e){return null!=e?on.createElementNS(e,n):on.createElement(n)}(n.tag,n.ns),null!=n.attrs&&M(n,an),(n.flags&yn)===yn&&n.body.body(n),fn(n.body)?O(n):null!=n.body&&(n.el.textContent=n.body)):n.type===$?n.el=e||function(n){return on.createTextNode(n)}(n.body):n.type===nn&&(n.el=e||function(n){return on.createComment(n)}(n.body))),n.el._node=n,n.el}function B(n,e,t,l,r,i,o,u){return function(a,f,s,d,c,v){var y,h;if(null!=d[l]){if(null==(y=d[l]._node))return void(d[l]=n(d[l]));if(function(n){return n.parent}(y)!==a)return h=n(d[l]),null!=y.vm?y.vm.unmount(!0):A(f,d[l]),void(d[l]=h)}if(d[r]==c)return kn;if(null==d[r].el)t(f,Y(d[r]),d[l]),d[r]=e(d[r],s);else if(d[r].el===d[l])d[r]=e(d[r],s),d[l]=n(d[l]);else{if(v||y!==d[o])return v&&null!=d[l]?function(n,e,t,l,r,i,o,u,a){if(u._lis)t(i,a[r].el,a[l]),a[r]=e(a[r],o);else{var f=function(n,e){var t,l=0,r=e.length-1;if(r<=2147483647)for(;l<=r;){if(t=l+r>>1,e[t]===n)return t;e[t]<n?l=t+1:r=t-1}else for(;l<=r;){if(t=Math.floor((l+r)/2),e[t]===n)return t;e[t]<n?l=t+1:r=t-1}return l==e.length?null:l}(u.idx,a.tombs);u._lis=!0;var s=n(a[l]);t(i,a[l],null!=f?o[a.tombs[f]].el:f),null==f?a.tombs.push(u.idx):a.tombs.splice(f,0,u.idx),a[l]=s}}(n,e,t,l,r,f,s,y,d):bn;h=d[l],d[l]=n(h),u(f,h,d[i]),d[i]=h}}}function F(n,e){var t=e.body,l=n.el,r=n.body,i={lftNode:r[0],rgtNode:r[r.length-1],lftSib:(t[0]||an).el,rgtSib:(t[t.length-1]||an).el};n:for(;;){for(;;){var o=mn(n,l,r,i,null,!1);if(o===bn)break;if(o===kn)break n}for(;;){var u=_n(n,l,r,i,i.lftNode,!1);if(u===bn)break;if(u===kn)break n}!function(n,e,t,l){for(var r=Array.prototype.slice.call(e.childNodes),i=[],o=0;o<r.length;o++){var u=r[o]._node;u.parent===n&&i.push(u.idx)}for(var a=function(n){var e=n.slice(),t=[];t.push(0);for(var l,r,i=0,o=n.length;i<o;++i){var u=t[t.length-1];if(n[u]<n[i])e[i]=u,t.push(i);else{for(l=0,r=t.length-1;l<r;){var a=(l+r)/2|0;n[t[a]]<n[i]?l=a+1:r=a}n[i]<n[t[l]]&&(l>0&&(e[i]=t[l-1]),t[l]=i)}}for(r=t[(l=t.length)-1];l-- >0;)t[l]=r,r=e[r];return t}(i).map(function(n){return i[n]}),f=0;f<a.length;f++)t[a[f]]._lis=!0;l.tombs=a;for(;;){var s=mn(n,e,t,l,null,!0);if(s===kn)break}}(n,l,r,i);break}}function P(n){return n.el._node.parent!==n.parent}function q(n,e,t){return e[t]}function z(n,e,t){for(;t<e.length;t++){var l=e[t];if(null!=l.vm){if(n.type===en&&l.vm.view===n.view&&l.vm.key===n.key||n.type===tn&&l.vm===n.vm)return l}else if(!P(l)&&n.tag===l.tag&&n.type===l.type&&n.key===l.key&&(n.flags&~dn)==(l.flags&~dn))return l}return null}function H(n,e,t){if(null==e._keys){if(e[t].key===n.key)return e[t];for(var l={},r=0;r<e.length;r++)l[e[r].key]=r;e._keys=l}return e[e._keys[n.key]]}function K(e,t){m(t.hooks,"willRecycle",t,e);var l=e.el=t.el,r=t.body,i=e.body;if(l._node=e,e.type!==$||i===r){null==e.attrs&&null==t.attrs||M(e,t);var o=fn(r),u=fn(i),a=(e.flags&yn)===yn;o?u||a?function(e,t){var l=e.body,r=l.length,i=t.body,o=i.length,u=(e.flags&yn)===yn,a=(e.flags&cn)===cn,f=(e.flags&vn)===vn,s=!a&&e.type===W,c=!0,v=0===o?n:f?H:a||u?q:z;if(s&&0===r)return E(t),void(u&&(e.body=[]));var y,h,p=0,b=!1,k=0;if(u)var m={key:null},_=Array(r);for(var w=0;w<r;w++){if(u){var x=!1,N=null;c&&(f&&(m.key=l.key(w)),y=v(m,i,k)),null!=y?(h=y.idx,!0===(N=l.diff(w,y))?((A=y).parent=e,A.idx=w,A._lis=!1):x=!0):x=!0,x&&(g(A=l.tpl(w),e,w),A._diff=null!=N?N:l.diff(w),null!=y&&K(A,y)),_[w]=A}else{var A=l[w],R=A.type;if(R<=nn)(y=c&&v(A,i,k))&&(K(A,y),h=y.idx);else if(R===en){if(y=c&&v(A,i,k)){h=y.idx;var S=y.vm._update(A.data,e,w)}else var S=U(A.view,A.data,A.key,A.opts)._redraw(e,w,!1);R=S.node.type}else if(R===tn){var C=d(A.vm),S=A.vm._update(A.data,e,w,C);R=S.node.type}}if(null!=y&&(h===k?++k===o&&r>o&&(y=null,c=!1):b=!0,!f&&o>100&&b&&++p%10==0))for(;k<o&&P(i[k]);)k++}u&&(e.body=_);s&&F(e,t)}(e,t):i!==r&&(null!=i?l.textContent=i:E(t)):u?(E(t),O(e)):i!==r&&(null!=i&&null!=r?l.firstChild.nodeValue=i:l.textContent=i),m(t.hooks,"didRecycle",t,e)}else l.nodeValue=i}function X(n,t,r,i){var u=this;u.view=n,u.data=t,u.key=r,i&&(u.opts=i,u.config(i));var a=e(n)?n:n.call(u,u,t,r,i);l(a)?u.render=a:(u.render=a.render,u.config(a)),u._redrawAsync=o(function(n){return u.redraw(!0)}),u._updateAsync=o(function(n){return u.update(n,!0)}),u.init&&u.init.call(u,u,u.data,u.key,i)}function Z(n,e,t,l){return null!=t&&(t.body[l]=e,e.idx=l,e.parent=t,e._lis=!1),n}function G(n,t,l,r){var i,o;return null==l?e(t)?i=t:o=t:(i=t,o=l),p(n,i,o,r)}function J(n,e,t,l){this.view=n,this.data=e,this.key=t,this.opts=l}function Q(n){this.vm=n}var W=1,$=2,nn=3,en=4,tn=5,ln="undefined"!=typeof window,rn=ln?window:{},on=ln?document:{},un=rn.requestAnimationFrame,an={},fn=Array.isArray,sn=(y.prototype={constructor:y,type:null,vm:null,key:null,ref:null,data:null,hooks:null,ns:null,el:null,tag:null,attrs:null,body:null,flags:0,_class:null,_diff:null,_dead:!1,_lis:!1,idx:null,parent:null},{}),dn=1,cn=2,vn=4,yn=8,hn=[],pn=n,gn=!1,bn=1,kn=2,mn=B(w,function(n,e){return e[n.idx+1]},S,"lftSib","lftNode","rgtSib","rgtNode",C),_n=B(function(n){return n.previousSibling},function(n,e){return e[n.idx-1]},C,"rgtSib","rgtNode","lftSib","lftNode",S),wn=(X.prototype={constructor:X,_diff:null,init:null,view:null,key:null,data:null,state:null,api:null,opts:null,node:null,hooks:null,onevent:n,refs:null,render:null,mount:function(n,e){return e?(E({el:n,flags:0}),this._redraw(null,null,!1),n.nodeName.toLowerCase()!==this.node.tag?(Y(this.node),S(n.parentNode,this.node.el,n),n.parentNode.removeChild(n)):S(n.parentNode,Y(this.node,n),n)):(this._redraw(null,null),n&&S(n,this.node.el)),n&&_(this),this},unmount:function(n){var e=this.node;A(e.el.parentNode,e.el),n||_(this)},config:function(n){n.init&&(this.init=n.init),n.diff&&(this.diff=n.diff),n.onevent&&(this.onevent=n.onevent),n.hooks&&(this.hooks=function(n){for(var e=arguments,t=1;t<e.length;t++)for(var l in e[t])n[l]=e[t][l];return n}(this.hooks||{},n.hooks))},parent:function(){return v(this.node.parent)},root:function(){for(var n=this.node;n.parent;)n=n.parent;return n.vm},redraw:function(n){null==n&&(n=gn);return n?this._redraw(null,null,d(this)):this._redrawAsync(),this},update:function(n,e){null==e&&(e=gn);return e?this._update(n,null,null,d(this)):this._updateAsync(n),this},_update:function(n,e,t,l){return null!=n&&this.data!==n&&(m(this.hooks,"willUpdate",this,n),this.data=n),this._redraw(e,t,l)},_redraw:function(n,e,t){var l,o,u=null==n,a=this.node&&this.node.el&&this.node.el.parentNode,f=this.node;if(null!=this.diff&&(l=this._diff,this._diff=o=this.diff(this,this.data),null!=f)){var s=fn(l)?i:r;if(l===o||s(l,o))return Z(this,f,n,e)}a&&m(this.hooks,"willRedraw",this,this.data);var d=this.render.call(this,this,this.data,l,o);if(d===f)return Z(this,f,n,e);if(this.refs=null,null!=this.key&&d.key!==this.key&&(d.key=this.key),this.node=d,n?(g(d,n,e,this),n.body[e]=d):f&&f.parent?(g(d,f.parent,f.idx,this),f.parent.body[f.idx]=d):g(d,null,null,this),!1!==t)if(f)if(f.tag!==d.tag||f.key!==d.key){f.vm=d.vm=null;var c=f.el.parentNode,v=w(f.el);A(c,f.el),S(c,Y(d),v),f.el=d.el,d.vm=this}else K(d,f);else Y(d);return a&&m(this.hooks,"didRedraw",this,this.data),u&&a&&_(this),this},_redrawAsync:null,_updateAsync:null},"http://www.w3.org/2000/svg");J.prototype={constructor:J,type:en,view:null,data:null,key:null,opts:null},Q.prototype={constructor:Q,type:tn,vm:null};return{config:function(n){pn=n.onevent||pn,null!=n.syncRedraw&&(gn=n.syncRedraw)},ViewModel:X,VNode:y,createView:U,defineElement:G,defineSvgElement:function(n,e,t,l){var r=G(n,e,t,l);return r.ns=wn,r},defineText:h,defineComment:function(n){var e=new y;return e.type=nn,e.body=n,e},defineView:function(n,e,t,l){return new J(n,e,t,l)},injectView:function(n){return new Q(n)},injectElement:function(n){var e=new y;return e.type=W,e.el=e.key=n,e},lazyList:function(n,e){var t=n.length,l={items:n,length:t,key:function(t){return e.key(n[t],t)},diff:function(t,l){var o=e.diff(n[t],t);if(null==l)return o;var u=l._diff;return(o===u||fn(u)?i(o,u):r(o,u))||o},tpl:function(t){return e.tpl(n[t],t)},map:function(n){return e.tpl=n,l},body:function(n){for(var e=Array(t),r=0;r<t;r++){var i=l.tpl(r);i._diff=l.diff(r),e[r]=i,g(i,n,r)}n.body=e}};return l},FIXED_BODY:cn,DEEP_REMOVE:dn,KEYED_LIST:vn,LAZY_LIST:yn}});