// https://github.com/leeoniya/domvm (3.x-dev, client build)
!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.domvm=e()}(this,function(){"use strict";var C=1,f=2,A=3,E=4,R=5,n="undefined"!=typeof window,e=n?window:{},a=n?document:{},o=e.requestAnimationFrame,O={};function I(){}var y=Array.isArray;function i(n){return null!=n&&n.constructor===Object}function u(n){return"function"==typeof n}function d(n){for(var e=arguments,t=1;t<e.length;t++)for(var l in e[t])n[l]=e[t][l];return n}function s(n,e){for(var t=[],l=e;l<n.length;l++)t.push(n[l]);return t}function p(n,e){for(var t in n)if(n[t]!==e[t])return!1;return!0}function h(n,e){var t=n.length;if(e.length!==t)return!1;for(var l=0;l<t;l++)if(n[l]!==e[l])return!1;return!0}function l(n){if(!o)return n;var e,t,l;function r(){e=0,n.apply(t,l)}return function(){t=this,l=arguments,e||(e=o(r))}}function c(n){return"o"===n[0]&&"n"===n[1]}function v(n){return"_"===n[0]}function m(n){return"style"===n}function b(n){n&&n.el&&n.el.offsetHeight}function V(n){return null!=n.node&&null!=n.node.el}function g(n,e){switch(e){case"value":case"checked":case"selected":return!0}return!1}function k(n){for(n=n||O;null==n.vm&&n.parent;)n=n.parent;return n.vm}function _(){}var t=_.prototype={constructor:_,type:null,vm:null,key:null,ref:null,data:null,hooks:null,ns:null,el:null,tag:null,attrs:null,body:null,flags:0,_class:null,_diff:null,_dead:!1,_lis:!1,idx:null,parent:null};function w(n){var e=new _;return e.type=f,e.body=n,e}var x=function(){return!1},r=I,N=I,S=I;function D(n,e){var t=N(n,function(n){t&&(null!=e.node&&e.redraw(),S(t))});return r(n)}function j(n,e){var t=N(n,function(n){t&&null!=e.node&&e.redraw()});return t}var M={},T=/\[(\w+)(?:=(\w+))?\]/g;var L=1,U=2,z=4,F=8;function G(n,e,t,l){var r=new _;r.type=C,r.flags=l||0,r.attrs=e||null;var o=function(n){var e,t,l,r,o=M[n];if(null==o)for(M[n]=o={tag:(e=n.match(/^[-\w]+/))?e[0]:"div",id:(t=n.match(/#([-\w]+)/))?t[1]:null,class:(l=n.match(/\.([-\w.]+)/))?l[1].replace(/\./g," "):null,attrs:null};r=T.exec(n);)null==o.attrs&&(o.attrs={}),o.attrs[r[1]]=r[2]||"";return o}(n);r.tag=o.tag;var a=null!=o.id,i=null!=o.class,u=null!=o.attrs;if(a||i||u){var f=r.attrs||{};if(a&&null==f.id&&(f.id=o.id),i&&(r._class=o.class,f.class=o.class+(null!=f.class?" "+f.class:"")),u)for(var d in o.attrs)null==f[d]&&(f[d]=o.attrs[d]);r.attrs=f}var s=r.attrs;return null!=s&&(null!=s._key&&(r.key=s._key),null!=s._ref&&(r.ref=s._ref),null!=s._hooks&&(r.hooks=s._hooks),null!=s._data&&(r.data=s._data),null!=s._flags&&(r.flags=s._flags),null==r.key&&(null!=r.ref?r.key=r.ref:null!=s.id?r.key=s.id:null!=s.name&&(r.key=s.name+("radio"===s.type||"checkbox"===s.type?s.value:"")))),null!=t&&(r.body=t),r}function P(n,e,t,l){if(n.type!==R&&n.type!==E){var r,o,a;n.parent=e,n.idx=t,n.vm=l,null!=n.ref&&(r=k(n),o=n.ref,a=n,function(n,e,t){for(var l;l=e.shift();)0===e.length?n[l]=t:n[l]=n=n[l]||{}}(r,("refs."+o).split("."),a));var i=n.hooks,u=l&&l.hooks;(i&&(i.willRemove||i.didRemove)||u&&(u.willUnmount||u.didUnmount))&&function(n){for(;n=n.parent;)n.flags|=L}(n),y(n.body)?function(n){for(var e=n.body,t=0;t<e.length;t++){var l=e[t];!1===l||null==l?e.splice(t--,1):y(l)?(o=l,a=t--,i=1,(r=e).splice.apply(r,[a,i].concat(o))):(null==l.type&&(e[t]=l=w(""+l)),l.type===f?null==l.body||""===l.body?e.splice(t--,1):0<t&&e[t-1].type===f?(e[t-1].body+=l.body,e.splice(t--,1)):P(l,n,t,null):P(l,n,t,null))}var r,o,a,i}(n):""===n.body?n.body=null:x(n.body)&&(n.body=D(n.body,k(n)))}}var W={animationIterationCount:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridRow:!0,gridColumn:!0,order:!0,lineClamp:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0};function Y(n,e){var t,l,r,o=(n.attrs||O).style,a=e?(e.attrs||O).style:null;if(null==o||("string"===(r=typeof o)||"number"===r))n.el.style.cssText=o;else{for(var i in o){var u=o[i];x(u)&&(o[i]=u=D(u,k(n))),(null==a||null!=u&&u!==a[i])&&(n.el.style[i]=(t=i,l=u,isNaN(l)||W[t]?l:l+"px"))}if(a)for(var f in a)null==o[f]&&(n.el.style[f]="")}}var B=[];function H(n,e,t,l,r){if(null!=n){var o=t.hooks[e];if(o){if("d"!==e[0]||"i"!==e[1]||"d"!==e[2])return o(t,l);r?b(t.parent)&&o(t,l):B.push([o,t,l])}}}function q(n){var e;if(B.length)for(b(n.node);e=B.shift();)e[0](e[1],e[2])}function K(n){return n.nextSibling}function X(n,e,t){var l=e._node,r=l.vm;if(y(l.body))if((l.flags&L)===L)for(var o=0;o<l.body.length;o++)X(e,l.body[o].el);else J(l);delete e._node,n.removeChild(e),H(l.hooks,"didRemove",l,null,t),null!=r&&(H(r.hooks,"didUnmount",r,r.data,t),r.node=null)}function Z(n,e){var t=e._node;if(!t._dead){var l,r,o,a,i=function n(e){var t=e.vm,l=null!=t&&H(t.hooks,"willUnmount",t,t.data),r=H(e.hooks,"willRemove",e);if((e.flags&L)===L&&y(e.body))for(var o=0;o<e.body.length;o++)n(e.body[o]);return l||r}(t);null!=i&&("object"==typeof(a=i)&&u(a.then))?(t._dead=!0,i.then((l=X,r=[n,e,!0],function(){return l.apply(o,r)}))):X(n,e)}}function J(n){for(var e=n.body,t=0;t<e.length;t++){var l=e[t];delete l.el._node,null!=l.vm&&(l.vm.node=null),y(l.body)&&J(l)}}function Q(n){var e=n.el;if(0==(n.flags&L))y(n.body)&&J(n),e.textContent=null;else{var t=e.firstChild;do{var l=K(t);Z(e,t)}while(t=l)}}function $(n,e,t){var l=e._node,r=null!=e.parentNode,o=e!==t&&r?null:l.vm;null!=o&&H(o.hooks,"willMount",o,o.data),H(l.hooks,r?"willReinsert":"willInsert",l),n.insertBefore(e,t),H(l.hooks,r?"didReinsert":"didInsert",l),null!=o&&H(o.hooks,"didMount",o,o.data)}function nn(n,e,t){$(n,e,t?K(t):null)}var en={};var tn=I,ln=!1;function rn(n,e,t){n[e]=t}function on(n,e,t,l,r){var o=n.apply(r,e.concat([t,l,r,r.data]));r.onevent(t,l,r,r.data,e),tn.call(null,t,l,r,r.data,e),!1===o&&(t.preventDefault(),t.stopPropagation())}function an(n){var e,t,l=function(n){for(;null==n._node;)n=n.parentNode;return n._node}(n.target),r=k(l),o=n.currentTarget._node.attrs["on"+n.type];if(y(o))on(e=o[0],t=o.slice(1),n,l,r);else for(var a in o)if(n.target.matches(a)){var i=o[a];y(i)?(e=i[0],t=i.slice(1)):(e=i,t=[]),on(e,t,n,l,r)}}function un(n,e,t,l){if(t!==l){var r=n.el;null==t||u(t)?rn(r,e,t):null==l&&rn(r,e,an)}}function fn(n,e,t,l,r){var o=n.el;null!=n.ns?o.setAttribute(e,t):"class"===e?o.className=t:"id"===e||"boolean"==typeof t||l?o[e]=t:"."===e[0]?o[e.substr(1)]=t:o.setAttribute(e,t)}function dn(n,e,t){var l,r,o,a=n.attrs||O,i=e.attrs||O;if(a===i);else{for(var u in a){var f=a[u];if(null!=f){var d=g(n.tag,u),s=d?n.el[u]:i[u];x(f)&&(a[u]=f=D(f,k(n))),f===s||(m(u)?Y(n,e):v(u)||(c(u)?un(n,u,f,s):fn(n,u,f,d)))}}for(var u in i)null==a[u]&&!v(u)&&(r=u,o=g((l=n).tag,u)||c(u),"."===r[0]&&(r=r.substr(1),o=!0),o?l.el[r]="":l.el.removeAttribute(r))}}function sn(n,e,t,l){return n.type===E&&(e=n.data,t=n.key,l=n.opts,n=n.view),new Sn(n,e,t,l)}function cn(n){for(var e=0;e<n.body.length;e++){var t=n.body[e],l=t.type;if(l<=A)$(n.el,vn(t));else if(l===E){l=(r=sn(t.view,t.data,t.key,t.opts)._redraw(n,e,!1)).node.type,$(n.el,vn(r.node))}else if(l===R){var r;(r=t.vm)._redraw(n,e),l=r.node.type,$(n.el,r.node.el)}}}function vn(n,e){var t,l,r,o;return null==n.el&&(n.type===C?(n.el=e||(r=n.tag,null!=(o=n.ns)?a.createElementNS(o,r):a.createElement(r)),null!=n.attrs&&dn(n,O),(n.flags&F)===F&&n.body.body(n),y(n.body)?cn(n):null!=n.body&&(n.el.textContent=n.body)):n.type===f?n.el=e||(l=n.body,a.createTextNode(l)):n.type===A&&(n.el=e||(t=n.body,a.createComment(t)))),(n.el._node=n).el}var yn=1,pn=2;function hn(u,f,d,s,c,v,y,p){return function(n,e,t,l,r,o){var a,i;if(null!=l[s]){if(null==(a=l[s]._node))return void(l[s]=u(l[s]));if(a.parent!==n)return i=u(l[s]),null!=a.vm?a.vm.unmount(!0):Z(e,l[s]),void(l[s]=i)}if(l[c]==r)return pn;if(null==l[c].el)d(e,vn(l[c]),l[s]),l[c]=f(l[c],t);else if(l[c].el===l[s])l[c]=f(l[c],t),l[s]=u(l[s]);else{if(o||a!==l[y])return o&&null!=l[s]?function(n,e,t,l,r,o,a,i,u){if(i._lis)t(o,u[r].el,u[l]),u[r]=e(u[r],a);else{var f=function(n,e){var t,l=0,r=e.length-1;if(r<=2147483647)for(;l<=r;){if(e[t=l+r>>1]===n)return t;e[t]<n?l=t+1:r=t-1}else for(;l<=r;){if(e[t=Math.floor((l+r)/2)]===n)return t;e[t]<n?l=t+1:r=t-1}return l==e.length?null:l}(i.idx,u.tombs);i._lis=!0;var d=n(u[l]);t(o,u[l],null!=f?a[u.tombs[f]].el:f),null==f?u.tombs.push(i.idx):u.tombs.splice(f,0,i.idx),u[l]=d}}(u,f,d,s,c,e,t,a,l):yn;i=l[s],l[s]=u(i),p(e,i,l[v]),l[v]=i}}}var mn=hn(K,function(n,e){return e[n.idx+1]},$,"lftSib","lftNode","rgtSib","rgtNode",nn),bn=hn(function(n){return n.previousSibling},function(n,e){return e[n.idx-1]},nn,"rgtSib","rgtNode","lftSib","lftNode",$);function gn(n,e,t,l){for(var r=[],o=r.slice.call(e.childNodes),a=0;a<o.length;a++){var i=o[a]._node;i.parent===n&&r.push(i.idx)}for(var u=function(n){var e,t,l=n.slice(),r=[];r.push(0);for(var o=0,a=n.length;o<a;++o){var i=r[r.length-1];if(n[i]<n[o])l[o]=i,r.push(o);else{for(e=0,t=r.length-1;e<t;){var u=(e+t)/2|0;n[r[u]]<n[o]?e=u+1:t=u}n[o]<n[r[e]]&&(0<e&&(l[o]=r[e-1]),r[e]=o)}}for(t=r[(e=r.length)-1];0<e--;)t=l[r[e]=t];return r}(r).map(function(n){return r[n]}),f=0;f<u.length;f++)t[u[f]]._lis=!0;for(l.tombs=u;;){if(mn(n,e,t,l,null,!0)===pn)break}}function kn(n){return n.el._node.parent!==n.parent}function _n(n,e,t){return e[t]}function wn(n,e,t){for(;t<e.length;t++){var l=e[t];if(null!=l.vm){if(n.type===E&&l.vm.view===n.view&&l.vm.key===n.key||n.type===R&&l.vm===n.vm)return l}else if(!kn(l)&&n.tag===l.tag&&n.type===l.type&&n.key===l.key&&(n.flags&~L)==(l.flags&~L))return l}return null}function xn(n,e,t){if(null==e._keys){if(e[t].key===n.key)return e[t];for(var l={},r=0;r<e.length;r++)l[e[r].key]=r;e._keys=l}return e[e._keys[n.key]]}function Nn(n,e){H(e.hooks,"willRecycle",e,n);var t=n.el=e.el,l=e.body,r=n.body;if((t._node=n).type!==f||r===l){null==n.attrs&&null==e.attrs||dn(n,e);var o=y(l),a=y(r),i=(n.flags&F)===F;o?a||i?function(n,e){var t=n.body,l=t.length,r=e.body,o=r.length,a=(n.flags&F)===F,i=(n.flags&U)===U,u=(n.flags&z)===z,f=!i&&n.type===C,d=!0,s=0===o?I:u?xn:i||a?_n:wn;if(f&&0===l)return Q(e),a&&(n.body=[]);var c,v,y=0,p=!1,h=0;if(a)var m={key:null},b=Array(l);for(var g=0;g<l;g++){if(a){var k=!1,_=null;d&&(u&&(m.key=t.key(g)),c=s(m,r,h)),null!=c?(v=c.idx,!0===(_=t.diff(g,c))?((w=c).parent=n,w.idx=g,w._lis=!1):k=!0):k=!0,k&&(P(w=t.tpl(g),n,g),w._diff=null!=_?_:t.diff(g),null!=c&&Nn(w,c)),b[g]=w}else{var w=t[g],x=w.type;if(x<=A)(c=d&&s(w,r,h))&&(Nn(w,c),v=c.idx);else if(x===E){if(c=d&&s(w,r,h)){v=c.idx;var N=c.vm._update(w.data,n,g)}else var N=sn(w.view,w.data,w.key,w.opts)._redraw(n,g,!1);x=N.node.type}else if(x===R){var S=V(w.vm),N=w.vm._update(w.data,n,g,S);x=N.node.type}}if(null!=c&&(v===h?++h===o&&o<l&&(c=null,d=!1):p=!0,!u&&100<o&&p&&++y%10==0))for(;h<o&&kn(r[h]);)h++}a&&(n.body=b);f&&function(n,e){var t=e.body,l=n.el,r=n.body,o={lftNode:r[0],rgtNode:r[r.length-1],lftSib:(t[0]||O).el,rgtSib:(t[t.length-1]||O).el};n:for(;;){for(;;){var a=mn(n,l,r,o,null,!1);if(a===yn)break;if(a===pn)break n}for(;;){var i=bn(n,l,r,o,o.lftNode,!1);if(i===yn)break;if(i===pn)break n}gn(n,l,r,o);break}}(n,e)}(n,e):r!==l&&(null!=r?t.textContent=r:Q(e)):a?(Q(e),cn(n)):r!==l&&(null!=r&&null!=l?t.firstChild.nodeValue=r:t.textContent=r),H(e.hooks,"didRecycle",e,n)}else t.nodeValue=r}function Sn(n,e,t,l){var r=this;r.view=n,r.data=e,r.key=t,x(e)&&(r._stream=j(e,r)),l&&(r.opts=l,r.config(l));var o=i(n)?n:n.call(r,r,e,t,l);u(o)?r.render=o:(r.render=o.render,r.config(o)),r.init&&r.init.call(r,r,r.data,r.key,l)}var Cn=Sn.prototype={constructor:Sn,_diff:null,init:null,view:null,key:null,data:null,state:null,api:null,opts:null,node:null,hooks:null,onevent:I,refs:null,render:null,mount:function(n,e){var t=this;e?(Q({el:n,flags:0}),t._redraw(null,null,!1),n.nodeName.toLowerCase()!==t.node.tag?(vn(t.node),$(n.parentNode,t.node.el,n),n.parentNode.removeChild(n)):$(n.parentNode,vn(t.node,n),n)):(t._redraw(null,null),n&&$(n,t.node.el));n&&q(t);return t},unmount:function(n){x(this._stream)&&S(this._stream);var e=this.node;Z(e.el.parentNode,e.el),n||q(this)},config:function(n){var e=this;n.init&&(e.init=n.init),n.diff&&(e.diff=n.diff),n.onevent&&(e.onevent=n.onevent),n.hooks&&(e.hooks=d(e.hooks||{},n.hooks)),n.onemit&&(e.onemit=d(e.onemit||{},n.onemit))},parent:function(){return k(this.node.parent)},root:function(){for(var n=this.node;n.parent;)n=n.parent;return n.vm},redraw:function(n){null==n&&(n=ln);var e=this;return n?e._redraw(null,null,V(e)):(e._redrawAsync=e._redrawAsync||l(function(n){return e.redraw(!0)}))(),e},update:function(n,e){null==e&&(e=ln);var t=this;return e?t._update(n,null,null,V(t)):(t._updateAsync=t._updateAsync||l(function(n){return t.update(n,!0)}))(n),t},_update:function(n,e,t,l){var r=this;null!=n&&r.data!==n&&(H(r.hooks,"willUpdate",r,n),r.data=n,x(r._stream)&&S(r._stream),x(n)&&(r._stream=j(n,r)));return r._redraw(e,t,l)},_redraw:function(n,e,t){var l,r,o=null==n,a=this,i=a.node&&a.node.el&&a.node.el.parentNode,u=a.node;if(null!=a.diff&&(l=a._diff,a._diff=r=a.diff(a,a.data),null!=u)){var f=y(l)?h:p,d=l===r||f(l,r);if(d)return An(a,u,n,e)}i&&H(a.hooks,"willRedraw",a,a.data);var s=a.render.call(a,a,a.data,l,r);if(s===u)return An(a,u,n,e);(a.refs=null)!=a.key&&s.key!==a.key&&(s.key=a.key);a.node=s,n?(P(s,n,e,a),n.body[e]=s):u&&u.parent?(P(s,u.parent,u.idx,a),u.parent.body[u.idx]=s):P(s,null,null,a);if(!1!==t)if(u)if(u.tag!==s.tag||u.key!==s.key){u.vm=s.vm=null;var c=u.el.parentNode,v=K(u.el);Z(c,u.el),$(c,vn(s),v),u.el=s.el,s.vm=a}else Nn(s,u);else vn(s);i&&H(a.hooks,"didRedraw",a,a.data),o&&i&&q(a);return a},_redrawAsync:null,_updateAsync:null};function An(n,e,t,l){return null!=t&&((t.body[l]=e).idx=l,e.parent=t,e._lis=!1),n}function En(n,e,t,l){var r,o;return null==t?i(e)?r=e:o=e:(r=e,o=t),G(n,r,o,l)}var Rn="http://www.w3.org/2000/svg";function On(n,e,t,l){this.view=n,this.data=e,this.key=t,this.opts=l}function In(n){this.vm=n}On.prototype={constructor:On,type:E,view:null,data:null,key:null,opts:null},In.prototype={constructor:In,type:R,vm:null};var Vn={config:function(n){var e,t;tn=n.onevent||tn,null!=n.syncRedraw&&(ln=n.syncRedraw),n.onemit&&(e=n.onemit,d(en,e)),n.stream&&(t=n.stream,x=t.is,r=t.val,N=t.sub,S=t.unsub)},ViewModel:Sn,VNode:_,createView:sn,defineElement:En,defineSvgElement:function(n,e,t,l){var r=En(n,e,t,l);return r.ns=Rn,r},defineText:w,defineComment:function(n){var e=new _;return e.type=A,e.body=n,e},defineView:function(n,e,t,l){return new On(n,e,t,l)},injectView:function(n){return new In(n)},injectElement:function(n){var e=new _;return e.type=C,e.el=e.key=n,e},lazyList:function(r,o){var a=r.length,i={items:r,length:a,key:function(n){return o.key(r[n],n)},diff:function(n,e){var t=o.diff(r[n],n);if(null==e)return t;var l=e._diff;return(t===l||y(l)?h(t,l):p(t,l))||t},tpl:function(n){return o.tpl(r[n],n)},map:function(n){return o.tpl=n,i},body:function(n){for(var e=Array(a),t=0;t<a;t++){var l=i.tpl(t);l._diff=i.diff(t),P(e[t]=l,n,t)}n.body=e}};return i},FIXED_BODY:U,DEEP_REMOVE:L,KEYED_LIST:z,LAZY_LIST:F};function Dn(n){var e,t,l=arguments,r=l.length;if(1<r){var o=1;i(l[1])&&(t=l[1],o=2),e=r!==o+1||l[o]instanceof _||l[o]instanceof On||l[o]instanceof In?s(l,o):l[o]}return G(n,t,e)}return t.patch=function(n,e){!function(n,e,t){if(null!=e.type){if(null!=n.vm)return;P(e,n.parent,n.idx,null),Nn(n.parent.body[n.idx]=e,n),t&&b(e),q(k(e))}else{var l=Object.create(n);l.attrs=d({},n.attrs);var r=d(n.attrs,e);if(null!=n._class){var o=r.class;r.class=null!=o&&""!==o?n._class+" "+o:n._class}dn(n,l),t&&b(n)}}(this,n,e)},Cn.emit=function(n){var e=this,t=e,l=s(arguments,1).concat(t,t.data);do{var r=e.onemit,o=r?r[n]:null;if(o){o.apply(e,l);break}}while(e=e.parent());en[n]&&en[n].apply(e,l)},Cn.onemit=null,Cn.body=function(){return function n(e,t){var l=e.body;if(y(l))for(var r=0;r<l.length;r++){var o=l[r];null!=o.vm?t.push(o.vm):n(o,t)}return t}(this.node,[])},Vn.defineElementSpread=Dn,Vn.defineSvgElementSpread=function(){var n=Dn.apply(null,arguments);return n.ns=Rn,n},Cn._stream=null,Cn.attach=function(n){return null==this.node&&this._redraw(null,null,!1),function n(e,t){var l=((e.el=t)._node=e).attrs;for(var r in l){var o=l[r],a=g(e.tag,r);m(r)||v(r)||(c(r)?un(e,r,o):null!=o&&a&&fn(e,r,o,a))}if((e.flags&F)===F&&e.body.body(e),y(e.body)&&0<e.body.length)for(var i=t.firstChild,u=0,f=e.body[u];f.type===E?f=sn(f.view,f.data,f.key,f.opts)._redraw(e,u,!1).node:f.type===R&&(f=f.node||f._redraw(e,u,!1).node),n(f,i),(i=i.nextSibling)&&(f=e.body[++u]););}(this.node,n),this},Vn});